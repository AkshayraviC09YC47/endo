const callself = require('callself')
const interops = require('interops')
const moduleinterops = require('./moduleinterops')

// const whatWouldNodejsRequireDo = '{"default":{"nameCollision":1},"nameCollision":3,"notDefault":2}'
// see _generateExpected.mjs
const whatWouldNodejsImportDo = '{"default":{"default":{"nameCollision":1},"nameCollision":3,"notDefault":2},"nameCollision":3,"notDefault":2}'



function assertInteropNameCollisions({ moduleReference, expect, name }) {
  const whatWeGot = stableOrderJson(moduleReference)
  if (whatWeGot !== expect) {
    throw Error(`Exporting a field called 'default' from a cjs module '${name}' should not override all other fields.
    What we got     : ${whatWeGot}
    What we expected: ${expect}`)
  }
}

function stableOrderJson(obj) {
  return JSON.stringify(obj, Object.keys(obj).sort());
}


module.exports.assertions = {
  packageWithDefaultField() {
    assertInteropNameCollisions({
      name: 'interops',
      moduleReference: interops,
      expect: whatWouldNodejsImportDo,
    })
  },
  moduleWithDefaultField() {
    assertInteropNameCollisions({
      name: 'moduleinterops',
      moduleReference: moduleinterops,
      expect: whatWouldNodejsImportDo,
    })
  },
  packageReferencingItself() {
    try {
      callself.makeTheCall()
    } catch (e) {
      throw Error('Referencing exported functions should be possible', { cause: e });
    }
  }
}
